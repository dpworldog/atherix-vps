<% var activePage='admin-tickets' ; %>
  <%- include('../partials/layout', { body: ` <a href="/admin/tickets" class="btn btn-secondary btn-sm mb-16"><i
      class="fas fa-arrow-left"></i> Back to Tickets</a>

    <div class="card animate-in mb-24">
      <div class="card-header">
        <div>
          <h2 style="font-size: 20px; font-weight: 800;">${typeof ticket !== 'undefined' ? ticket.title : 'Ticket'}</h2>
          <div style="display:flex; gap: 8px; margin-top: 6px; align-items: center; flex-wrap: wrap;">
            <span class="badge badge-${typeof ticket !== 'undefined' ? (ticket.status || 'open') : 'open'}">${typeof
              ticket !== 'undefined' ? (ticket.status || 'open') : 'open'}</span>
            <span
              class="badge badge-${typeof ticket !== 'undefined' ? (ticket.priority || 'medium') : 'medium'}">${typeof
              ticket !== 'undefined' ? (ticket.priority || 'medium') : 'medium'}</span>
            <span class="text-sm text-secondary">#${typeof ticket !== 'undefined' ? (ticket._id || ticket.id) : ''} • by
              ${typeof ticket !== 'undefined' && ticket.user && ticket.user.username ? ticket.user.username :
              'Unknown'}</span>
          </div>
        </div>
        <div style="display:flex; gap: 6px;">
          <button class="btn btn-success btn-sm"
            onclick="changeTicketStatus(${typeof ticket !== 'undefined' ? (ticket._id || ticket.id) : 0}, 'resolved')"><i
              class="fas fa-check"></i> Resolve</button>
          <button class="btn btn-danger btn-sm"
            onclick="changeTicketStatus(${typeof ticket !== 'undefined' ? (ticket._id || ticket.id) : 0}, 'closed')"><i
              class="fas fa-times"></i> Close</button>
        </div>
      </div>

      <div class="chat-messages">
        ${typeof ticket !== 'undefined' && ticket.messages ? ticket.messages.map(m =>
        '<div class="chat-msg ' + (m.isAdmin || m.is_admin ? 'admin' : '') + '">' +
          '<div class="chat-avatar ' + (m.isAdmin || m.is_admin ? 'admin-avatar-msg' : 'user-avatar-msg') + '">' +
            ((m.sender && m.sender.username) ? m.sender.username.charAt(0).toUpperCase() : '?') + '</div>' +
          '<div>' +
            '<div class="chat-bubble">' + (m.message || m.content || '') + '</div>' +
            '<div class="chat-meta">' + ((m.sender && m.sender.username) || 'User') + (m.isAdmin || m.is_admin ? '
              (Admin)' : '') + ' • ' + new Date(m.createdAt || m.created_at || Date.now()).toLocaleString() + '</div>' +
            '</div>' +
          '</div>'
        ).join('') : '<p class="text-secondary" style="text-align:center; padding:20px;">No messages</p>'}
      </div>

      <form action="/admin/tickets/${typeof ticket !== 'undefined' ? (ticket._id || ticket.id) : ''}/reply"
        method="POST" style="margin-top: 16px; display: flex; gap: 10px;">
        <textarea name="message" class="form-control" placeholder="Reply as admin..." required
          style="resize: vertical; min-height: 60px; flex: 1;"></textarea>
        <button type="submit" class="btn btn-primary" style="align-self: flex-end;"><i
            class="fas fa-paper-plane"></i></button>
      </form>
    </div>
    ` }) %>