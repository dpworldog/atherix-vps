<% locals.activePage = 'vps'; locals.pageTitle = vps.name; %>
<%- include('../partials/header') %>

<div class="page-header fade-up">
  <div style="display: flex; align-items: center; gap: 14px;">
    <a href="/vps" style="color: var(--text-muted); text-decoration: none; font-size: 20px;"><i class="fas fa-arrow-left"></i></a>
    <div>
      <div class="page-heading"><%= vps.name %></div>
      <div class="page-subheading" style="font-family: var(--font-mono); font-size: 12px;"><%= vps.hostname %></div>
    </div>
  </div>
  <div style="display: flex; gap: 10px; align-items: center;">
    <span class="badge badge-<%= vps.status %>" data-vps-status="<%= vps._id %>" style="font-size: 13px; padding: 6px 14px;">
      <span class="badge-dot"></span><%= vps.status %>
    </span>
    <% if (vps.status === 'running') { %>
      <button class="btn btn-warning vps-action-btn" data-vps-id="<%= vps._id %>" data-action="restart"><i class="fas fa-rotate-right"></i> Restart</button>
      <button class="btn btn-danger vps-action-btn" data-vps-id="<%= vps._id %>" data-action="stop"><i class="fas fa-stop"></i> Stop</button>
    <% } else if (vps.status === 'stopped') { %>
      <button class="btn btn-success vps-action-btn" data-vps-id="<%= vps._id %>" data-action="start"><i class="fas fa-play"></i> Start</button>
    <% } %>
  </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
  <div style="display: flex; flex-direction: column; gap: 20px;">

    <!-- Connection Info -->
    <div class="card fade-up">
      <div class="card-header"><div class="card-title"><i class="fas fa-plug"></i> Connection Details</div></div>
      <div class="card-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
          <div>
            <div class="form-label">IP Address</div>
            <div class="code-block" style="display: flex; align-items: center; justify-content: space-between;">
              <span id="vpsIp"><%= vps.network && vps.network.ipv4 ? vps.network.ipv4 : 'Pending...' %></span>
              <button class="copy-btn" data-value="<%= vps.network && vps.network.ipv4 ? vps.network.ipv4 : '' %>" style="position: static;"><i class="fas fa-copy"></i></button>
            </div>
          </div>
          <div>
            <div class="form-label">SSH Port</div>
            <div class="code-block"><%= vps.sshPort || 22 %></div>
          </div>
          <div>
            <div class="form-label">Gateway</div>
            <div class="code-block"><%= vps.network && vps.network.gateway ? vps.network.gateway : process && process.env ? 'N/A' : 'N/A' %></div>
          </div>
          <div>
            <div class="form-label">Root Password</div>
            <div class="code-block" id="rootPassContainer" style="display: flex; align-items: center; justify-content: space-between;">
              <span id="rootPass" style="filter: blur(4px); user-select: none;"><%= vps.rootPassword || 'auto-generated' %></span>
              <div style="display: flex; gap: 6px;">
                <button type="button" onclick="togglePass()" style="position: static; background: none; border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); padding: 2px 8px; cursor: pointer; font-size: 10px;"><i class="fas fa-eye" id="eyeIcon"></i></button>
                <button class="copy-btn" data-value="<%= vps.rootPassword || '' %>" style="position: static;"><i class="fas fa-copy"></i></button>
              </div>
            </div>
          </div>
        </div>

        <% if (vps.network && vps.network.ipv4 && vps.status === 'running') { %>
          <div style="margin-top: 16px;">
            <div class="form-label">SSH Command</div>
            <div class="code-block" style="display: flex; align-items: center; justify-content: space-between;">
              <span id="sshCmd">ssh root@<%= vps.network.ipv4 %> -p <%= vps.sshPort || 22 %></span>
              <button class="copy-btn" data-value="ssh root@<%= vps.network.ipv4 %> -p <%= vps.sshPort || 22 %>" style="position: static;"><i class="fas fa-copy"></i></button>
            </div>
          </div>
        <% } %>
      </div>
    </div>

    <!-- VPS Specs -->
    <div class="card fade-up">
      <div class="card-header"><div class="card-title"><i class="fas fa-microchip"></i> Resources</div></div>
      <div class="card-body">
        <div class="resource-bar">
          <div class="resource-bar-label"><span>CPU (<%= vps.plan.cpu %> vCore<%= vps.plan.cpu > 1 ? 's' : '' %>)</span><span>—</span></div>
          <div class="bar-track"><div class="bar-fill" style="width: <%= vps.status === 'running' ? Math.floor(Math.random()*40)+5 : 0 %>%"></div></div>
        </div>
        <div class="resource-bar">
          <div class="resource-bar-label"><span>RAM (<%= vps.plan.ram >= 1024 ? (vps.plan.ram/1024).toFixed(1)+'GB' : vps.plan.ram+'MB' %>)</span><span>—</span></div>
          <div class="bar-track"><div class="bar-fill" style="width: <%= vps.status === 'running' ? Math.floor(Math.random()*50)+10 : 0 %>%; background: linear-gradient(90deg, #00ff88, #00cc6a);"></div></div>
        </div>
        <div class="resource-bar">
          <div class="resource-bar-label"><span>Disk (<%= vps.plan.disk %>GB)</span><span>—</span></div>
          <div class="bar-track"><div class="bar-fill" style="width: <%= Math.floor(Math.random()*20)+5 %>%; background: linear-gradient(90deg, var(--purple), #6633cc);"></div></div>
        </div>
      </div>
    </div>

    <!-- Features -->
    <div class="card fade-up">
      <div class="card-header"><div class="card-title"><i class="fas fa-cogs"></i> Enabled Features</div></div>
      <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
          <% ['nesting', 'docker', 'kvm', 'fuse'].forEach(function(feat) { %>
            <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; border: 1px solid <%= vps.features && vps.features[feat] ? 'rgba(0,255,136,0.2)' : 'var(--border-subtle)' %>; background: <%= vps.features && vps.features[feat] ? 'var(--green-bg)' : 'transparent' %>;">
              <i class="fas fa-<%= feat === 'nesting' ? 'layer-group' : feat === 'docker' ? 'docker' : feat === 'kvm' ? 'server' : 'database' %>" style="color: <%= vps.features && vps.features[feat] ? 'var(--green)' : 'var(--text-muted)' %>; width: 16px;"></i>
              <div>
                <div style="font-size: 13px; font-weight: 600; color: <%= vps.features && vps.features[feat] ? 'var(--text-primary)' : 'var(--text-muted)' %>;"><%= feat.toUpperCase() %></div>
                <div style="font-size: 10px; color: <%= vps.features && vps.features[feat] ? 'var(--green)' : 'var(--text-muted)' %>;"><%= vps.features && vps.features[feat] ? 'Enabled' : 'Disabled' %></div>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div style="display: flex; flex-direction: column; gap: 20px;">
    <div class="card fade-up">
      <div class="card-header"><div class="card-title"><i class="fas fa-info-circle"></i> VPS Info</div></div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <% [
            {label: 'Plan', value: vps.plan.name},
            {label: 'OS', value: vps.os},
            {label: 'LXC ID', value: '#' + vps.lxcId},
            {label: 'Created', value: new Date(vps.createdAt).toLocaleDateString('en-US', {year:'numeric',month:'short',day:'numeric'})},
            {label: 'Last Action', value: new Date(vps.lastAction).toLocaleString()},
            {label: 'Auto-start', value: vps.autoStart ? 'Enabled' : 'Disabled'}
          ].forEach(function(item) { %>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-subtle); font-size: 13px;">
              <span style="color: var(--text-muted);"><%= item.label %></span>
              <span style="color: var(--text-primary); font-family: var(--font-mono); font-size: 12px;"><%= item.value %></span>
            </div>
          <% }); %>
        </div>
      </div>
    </div>

    <div class="card fade-up">
      <div class="card-header"><div class="card-title"><i class="fas fa-exclamation-triangle" style="color: var(--red);"></i> Danger Zone</div></div>
      <div class="card-body">
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 14px;">Permanently delete this VPS. This action cannot be undone.</p>
        <form action="/vps/<%= vps._id %>/delete" method="POST" onsubmit="return confirm('Are you absolutely sure? This will permanently delete the VPS <%= vps.name %> and all its data.')">
          <button type="submit" class="btn btn-danger" style="width: 100%; justify-content: center;">
            <i class="fas fa-trash-alt"></i> Delete VPS
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
let passVisible = false;
function togglePass() {
  const el = document.getElementById('rootPass');
  const icon = document.getElementById('eyeIcon');
  passVisible = !passVisible;
  el.style.filter = passVisible ? 'none' : 'blur(4px)';
  icon.className = passVisible ? 'fas fa-eye-slash' : 'fas fa-eye';
}

// Auto-refresh status
setInterval(async () => {
  try {
    const res = await fetch('/api/vps/<%= vps._id %>/status');
    const data = await res.json();
    if (data.status) {
      const badge = document.querySelector('[data-vps-status]');
      if (badge) {
        badge.className = `badge badge-${data.status}`;
        badge.innerHTML = `<span class="badge-dot"></span>${data.status}`;
      }
    }
  } catch {}
}, 15000);
</script>

<%- include('../partials/footer') %>
